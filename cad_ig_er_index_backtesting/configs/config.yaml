# ============================================================================
# COMPREHENSIVE BACKTESTING FRAMEWORK CONFIGURATION
# ============================================================================
# This file contains all configuration settings for the backtesting framework.
# 
# QUICK NAVIGATION:
#   1. DATA CONFIGURATION (lines ~10-60)
#   2. PORTFOLIO CONFIGURATION (lines ~62-70)
#   3. REPORTING CONFIGURATION (lines ~72-80)
#   4. FEATURE ENGINEERING CONFIGURATION (lines ~82-140)
#   5. STRATEGY CONFIGURATIONS (lines ~142-300)
#      - Cross-Asset Momentum
#      - Multi-Asset Momentum
#      - Genetic Algorithm
#      - Volatility-Adaptive Momentum
#      - LightGBM Machine Learning
#      - Random Forest Ensemble
#      - Logistic Regression
#   6. STRATEGY SELECTION CONTROL (lines ~302-320)
#   7. ENHANCED REPORTING CONFIGURATION (lines ~322-330)
#   8. COMMON SETTINGS (lines ~332-340)
# ============================================================================

# ============================================================================
# SECTION 1: DATA CONFIGURATION
# ============================================================================
# Configure data loading, preprocessing, and validation settings
# ============================================================================
data:
  # --- File Path and Format ---
  file_path: "../market data pipeline/processed market data/cad_ig_er_index_data_for_backtest.csv"
  date_column: "Date"
  use_multi_index: false  # Simple CSV format (not multi-index)
  multi_index_header_rows: 2
  date_header_row: 2
  
  # --- Asset Filtering ---
  # Asset class filtering (not used for simple CSV)
  asset_classes_include: null
  asset_classes_exclude: null
  
  # Column filtering (not used for simple CSV - all columns are loaded directly)
  columns_include: null
  columns_exclude: null
  
  # --- Date Range Filtering ---
  resample_frequency: null # Use raw daily data, or specify frequency like "W-FRI"
  start_date: null  # "2002-11-01" - specify to filter date range
  end_date: null
  
  # --- Missing Data Handling ---
  missing_data_strategy: "forward_fill"  # Options: forward_fill, backward_fill, interpolate, drop, fill_value
  missing_data_fill_value: 0.0
  
  # --- Outlier Detection ---
  outlier_detection_enabled: false
  outlier_method: "iqr"  # Options: iqr, zscore
  outlier_threshold: 3.0
  outlier_action: "flag"  # Options: flag, remove, clip
  
  # --- Gap Detection ---
  gap_detection_enabled: false
  max_gap_days: 7
  gap_action: "flag"  # Options: flag, fill, drop
  
  # --- Data Validation ---
  data_validation_enabled: true
  min_value: null
  max_value: null
  
  # --- Column Transformations ---
  column_rename_map: null  # Format: {"old_name": "new_name"}
  force_numeric: true
  
  # --- Multi-Index Flattening ---
  flatten_columns: true  # Always use 2nd level (column names)
  
  # --- Asset Identification ---
  benchmark_asset: "cad_ig_er_index"
  trading_asset: "cad_ig_er_index"
  assets: []  # Will be populated after flattening, or specify explicitly
  required_columns: []

# ============================================================================
# SECTION 2: PORTFOLIO CONFIGURATION
# ============================================================================
# Configure portfolio settings for backtesting
# ============================================================================
portfolio:
  initial_capital: 100
  frequency: "D" # Daily frequency for calculations
  fees: 0.0
  slippage: 0.0
  position_size: 1.0
  leverage: 1.0

# ============================================================================
# SECTION 3: REPORTING CONFIGURATION
# ============================================================================
# Configure report generation and output settings
# ============================================================================
reporting:
  output_dir: "outputs/reports"
  generate_html: true
  generate_pdf: false
  include_plots: true
  metrics_precision: 4

# ============================================================================
# SECTION 4: FEATURE ENGINEERING CONFIGURATION
# ============================================================================
# Configure technical indicators and feature creation
# All parameters are in trading days
# ============================================================================
features:
  # --- Primary Settings ---
  primary_asset: "cad_ig_er_index"
  fill_na_value: 0.0
  
  # --- Momentum Features ---
  momentum_periods: [5, 10, 15, 20, 30, 40, 60, 65, 130, 260] # Scaled from weeks
  
  # --- Volatility Features ---
  volatility_windows: [20, 40, 65, 130] # Scaled from weeks
  
  # --- Moving Average Features ---
  sma_windows: [20, 40, 65, 130] # Scaled from weeks
  
  # --- Technical Indicators ---
  include_macd: true
  macd_fast: 12
  macd_slow: 26
  macd_signal: 9
  
  include_stochastic: true
  stochastic_k_period: 14
  
  include_rsi: false
  include_bollinger: false
  
  # --- OAS and VIX Features ---
  include_oas_features: true
  oas_momentum_period: 20 # Scaled from 4 weeks
  include_vix: true
  
  # --- Correlation and Relative Strength ---
  include_correlations: false
  include_relative_strength: false
  
  # --- Z-Score Features (for Logistic Regression) ---
  include_zscore_features: true
  zscore_columns: ["cad_oas", "vix", "us_3m_10y"]
  zscore_window: 252
  
  # --- Equity Index Returns ---
  include_equity_index_features: true
  equity_index_columns: ["tsx", "s&p_500"]
  equity_index_periods: [1, 5, 21]
  
  # --- Daily Change Features ---
  include_daily_change_features: true
  daily_change_columns: ["cad_oas", "vix", "us_3m_10y"]
  
  # --- Macro Surprise Indicators ---
  include_macro_surprise_features: true
  macro_surprise_columns:
    - "us_growth_surprises"
    - "us_inflation_surprises"
    - "us_hard_data_surprises"
    - "us_equity_revisions"
    - "us_lei_yoy"

# ============================================================================
# SECTION 5: STRATEGY CONFIGURATIONS
# ============================================================================
# Individual strategy parameter settings
# ============================================================================

# --- Strategy 5.1: Cross-Asset Momentum ---
# Weekly rebalancing strategy using momentum across multiple assets
cross_asset_momentum:
  momentum_assets: ["cad_ig_er_index", "tsx", "s&p_500"]
  momentum_lookback_days: 10 # Scaled from 2 weeks
  min_confirmations: 2  # Updated to match number of available assets

# --- Strategy 5.2: Multi-Asset Momentum ---
# Combined momentum signal from multiple assets with time-based exits
multi_asset_momentum:
  momentum_assets_map:
    tsx: "tsx"
    spx: "s&p_500"
    cad_ig: "cad_ig_er_index"
  momentum_lookback_days: 20 # Scaled from 4 weeks
  signal_threshold: -0.005
  exit_hold_days: 5 # Scaled from 1 week

# --- Strategy 5.3: Genetic Algorithm ---
# Evolves trading rules using genetic algorithm optimization
genetic_algorithm:
  population_size: 120
  max_generations: 120
  mutation_rate: 0.40
  crossover_rate: 0.40
  target_return_early_stop: 0.70
  max_clauses_per_rule: 4
  elite_size: 25
  fitness_drawdown_penalty_factor: 0.1
  initial_cash_ga: 10000

# --- Strategy 5.4: Volatility-Adaptive Momentum ---
# Momentum strategy that adapts to volatility regimes using VIX
vol_adaptive_momentum:
  price_column: "cad_ig_er_index"
  vix_column: "vix"
  mom_lookback: 20
  vol_lookback: 20
  vix_z_lookback: 252
  thr_low_vol: 0.60
  thr_high_vol: 0.00
  max_hold: 10
  scale: 0.005

# --- Strategy 5.5: LightGBM Machine Learning ---
# Advanced ML strategy using LightGBM gradient boosting
# Optimized for 144.6%+ total return breakthrough performance
lightgbm_strategy:
  trading_asset: "cad_ig_er_index"
  benchmark_asset: "cad_ig_er_index"
  
  # Feature engineering parameters (comprehensive)
  momentum_periods: [1, 3, 5, 10, 20, 40, 60, 120, 252]  # Multi-timeframe momentum
  volatility_periods: [5, 10, 20, 60]                     # Volatility windows
  ma_periods: [5, 10, 20, 50, 200]                        # Moving average periods
  
  # Model parameters
  prediction_horizons: [1, 5, 10]  # Predict 1-day, 5-day, and 10-day forward returns
  train_test_split: 0.7            # 70% train, 30% test
  min_train_samples: 500           # Minimum samples for training
  
  # LightGBM hyperparameters (optimized for financial time series)
  num_leaves: 31                   # Number of leaves in tree
  learning_rate: 0.05              # Learning rate for gradient boosting
  feature_fraction: 0.8            # Fraction of features to use per iteration
  bagging_fraction: 0.8            # Fraction of data to use per iteration
  bagging_freq: 5                  # Frequency for bagging
  max_depth: 7                     # Maximum tree depth
  min_child_samples: 20            # Minimum samples per leaf
  reg_alpha: 0.1                   # L1 regularization
  reg_lambda: 0.1                  # L2 regularization
  n_estimators: 200                # Number of boosting rounds
  
  # Threshold optimization parameters
  optimize_threshold: true         # Enable threshold optimization
  threshold_range: [0.45, 0.65]    # Range to search for optimal threshold
  threshold_steps: 20              # Number of steps in threshold search
  
  # Risk management
  use_ensemble: true               # Use ensemble of multiple models
  min_prediction_confidence: 0.5   # Minimum confidence for signal
  
  # Random seed for reproducibility
  random_seed: 42

# --- Strategy 5.6: Random Forest Ensemble ---
# 4-model Random Forest ensemble achieving 3.86% annualized return
rf_ensemble_strategy:
  trading_asset: "cad_ig_er_index"
  benchmark_asset: "cad_ig_er_index"
  
  # Feature engineering parameters
  momentum_windows: [2, 3, 5, 7, 10, 12, 15, 20, 25, 30, 40, 50, 60, 90, 120]
  zscore_windows: [5, 10, 20, 40, 60, 120, 252]
  macro_windows: [3, 5, 10, 20, 40, 60, 90]
  
  # Model configurations (4 Random Forest models)
  # Each model has different hyperparameters for diversity
  models:
    # Model 1: Deep trees, moderate samples
    - n_estimators: 600
      max_depth: 15
      min_samples_leaf: 5
      max_features: 0.4
      random_state: 42
    
    # Model 2: More trees, shallower, conservative
    - n_estimators: 700
      max_depth: 12
      min_samples_leaf: 8
      max_features: 0.5
      random_state: 42
    
    # Model 3: Very deep, fewer trees
    - n_estimators: 500
      max_depth: 18
      min_samples_leaf: 5
      max_features: 0.3
      random_state: 123
    
    # Model 4: Many trees, shallow, more conservative
    - n_estimators: 800
      max_depth: 10
      min_samples_leaf: 10
      max_features: 0.4
      random_state: 456
  
  # Ensemble parameters
  ensemble_weights: [0.30, 0.30, 0.25, 0.15]  # Weights for each model
  probability_threshold: 0.55                  # Entry threshold
  
  # Trading rules
  holding_period_days: 7                       # Minimum holding period
  train_test_split: 0.70                       # 70% train, 30% test

# --- Strategy 5.7: Logistic Regression ---
# Logistic regression with comprehensive feature engineering and threshold optimization
logistic_regression_strategy:
  trading_asset: "cad_ig_er_index"
  benchmark_asset: "cad_ig_er_index"
  
  # Model parameters
  prediction_horizon: 5  # Days ahead to predict (5-day forward returns)
  train_test_split: 0.7  # 70% train, 30% test
  random_seed: 42
  
  # Logistic regression hyperparameters
  max_iter: 1000  # Maximum iterations for convergence
  C: 1.0  # Regularization strength (inverse of regularization)
  
  # Threshold optimization parameters
  optimize_threshold: true  # Enable threshold optimization
  threshold_range: [0.45, 0.65]  # Range to search for optimal threshold
  threshold_steps: 20  # Number of steps in threshold search
  default_threshold: 0.55  # Default threshold if optimization disabled
  
  # Model persistence
  model_dir: "outputs/models"  # Directory to save/load models
  save_model: true  # Save trained model to disk
  load_model: true  # Load model from disk if available
  
  # Diagnostics
  diagnostics_dir: "outputs/results"  # Directory to save diagnostics
  save_diagnostics: true  # Save diagnostics to file

# ============================================================================
# SECTION 6: STRATEGY SELECTION CONTROL
# ============================================================================
# Control which strategies are enabled and how they run
# ============================================================================
strategies:
  enabled:
    - "cross_asset_momentum"
    - "multi_asset_momentum"
    - "genetic_algorithm"
    - "vol_adaptive_momentum"
    - "lightgbm_strategy"
    - "rf_ensemble_strategy"
    - "logistic_regression_strategy"
  # Available options: cross_asset_momentum, multi_asset_momentum, genetic_algorithm, 
  #                    vol_adaptive_momentum, lightgbm_strategy, rf_ensemble_strategy, 
  #                    logistic_regression_strategy
  run_all_by_default: true

# ============================================================================
# SECTION 7: ENHANCED REPORTING CONFIGURATION
# ============================================================================
# Configure detailed reporting and statistics generation
# ============================================================================
enhanced_reporting:
  generate_detailed_stats_file: true
  stats_file_name: "comprehensive_strategy_comparison.txt"
  include_vectorbt_stats: true
  include_quantstats_metrics: true
  include_manual_calculations: true
  include_drawdown_analysis: true

# ============================================================================
# SECTION 8: VALIDATION CONFIGURATION
# ============================================================================
# Validation framework settings based on LÃ³pez de Prado methodologies
# ============================================================================
validation:
  # Cross-validation settings
  cv_method: "walk_forward"  # Changed to walk_forward to enable walk-forward analysis
  n_splits: 5
  embargo_pct: 0.01  # 1% embargo period
  
  # CPCV settings
  n_test_groups: 2  # Number of groups for test set in CPCV
  
  # Sample weights
  use_sample_weights: true
  weight_method: "uniqueness"  # Options: "uniqueness", "time_decay", "sequential_bootstrap"
  time_decay_factor: 0.01
  
  # Deflated Sharpe Ratio
  n_trials: 1  # Number of strategies tested (for deflated SR) - Reduced from 100 to improve DSR
  
  # PBO settings
  calculate_pbo: true
  n_configurations: 50  # Number of configurations for PBO calculation
  
  # Walk-forward settings
  walk_forward_train_period: 252  # Days
  walk_forward_test_period: 63   # Days
  walk_forward_step: 21           # Days
  
  # Synthetic data testing (disabled by default - use actual strategy data)
  synthetic_test_enabled: false
  n_simulations: 1000
  
  # Minimum backtest length
  min_backtest_length_enabled: true
  target_sharpe: 0.7  # Reduced from 1.5 to realistic target to improve MinBTL validation
  
  # Output settings
  output_dir: "outputs/validation"
  generate_report: true
  
  # Auto-run validation during normal strategy execution
  auto_run: true  # Set to false to disable automatic validation

# ============================================================================
# SECTION 9: COMMON SETTINGS
# ============================================================================
# Global settings applied across all strategies
# ============================================================================
random_seed: 7
verbose: true
log_level: "INFO"
