{
  "permissions": {
    "allow": [
      "Bash(python -c \"\nimport pandas as pd\nimport numpy as np\n\n# Load data\ndf = pd.read_csv(''data_pipelines/data_processed/with_er_daily.csv'')\ndf[''Date''] = pd.to_datetime(df[''Date''])\ndf = df.sort_values(''Date'').reset_index(drop=True)\n\n# Target: 7-day forward return\ndf[''target_7d''] = df[''cad_ig_er_index''].pct_change(7).shift(-7)\n\n# Key features based on correlation analysis\n# Strong negative correlations: Z-scores (buy when spreads spike)\n# Strong positive correlations: Moving averages and equity revisions changes\n\n# Z-score features\nfor window in [5, 10, 20, 30, 60]:\n    df[f''cad_oas_ma{window}''] = df[''cad_oas''].rolling(window).mean()\n    df[f''cad_oas_std{window}''] = df[''cad_oas''].rolling(window).std()\n    df[f''cad_oas_zscore{window}''] = (df[''cad_oas''] - df[f''cad_oas_ma{window}'']) / df[f''cad_oas_std{window}'']\n    \n    df[f''us_hy_oas_ma{window}''] = df[''us_hy_oas''].rolling(window).mean()\n    df[f''us_hy_oas_std{window}''] = df[''us_hy_oas''].rolling(window).std()\n    df[f''us_hy_oas_zscore{window}''] = (df[''us_hy_oas''] - df[f''us_hy_oas_ma{window}'']) / df[f''us_hy_oas_std{window}'']\n    \n    df[f''vix_ma{window}''] = df[''vix''].rolling(window).mean()\n    df[f''vix_std{window}''] = df[''vix''].rolling(window).std()\n    df[f''vix_zscore{window}''] = (df[''vix''] - df[f''vix_ma{window}'']) / df[f''vix_std{window}'']\n\ndf[''cad_oas_pct5''] = df[''cad_oas''].pct_change(5)\n\n# Equity revisions changes\nfor window in [5, 20, 60]:\n    df[f''us_equity_revisions_change{window}''] = df[''us_equity_revisions''].diff(window)\n\n# Clean data\ndf_clean = df.dropna()\n\nprint(f''Clean dataset: {len(df_clean)} rows'')\n\n# Strategy 1: Simple mean reversion on CAD OAS z-score\n# Buy when CAD OAS spikes (high z-score = wide spreads = cheap bonds)\ndef backtest_strategy(df, signal_col, threshold_low, threshold_high, holding_period=7):\n    df = df.copy()\n    df[''signal''] = 0\n    df.loc[df[signal_col] > threshold_high, ''signal''] = 1  # Buy when spreads spike\n    \n    # Hold for minimum period\n    df[''position''] = 0\n    current_pos = 0\n    hold_counter = 0\n    \n    for i in range(len(df)):\n        if hold_counter > 0:\n            df.loc[df.index[i], ''position''] = current_pos\n            hold_counter -= 1\n        elif df[''signal''].iloc[i] == 1:\n            current_pos = 1\n            df.loc[df.index[i], ''position''] = 1\n            hold_counter = holding_period - 1\n        else:\n            current_pos = 0\n            df.loc[df.index[i], ''position''] = 0\n    \n    # Calculate returns\n    df[''daily_ret''] = df[''cad_ig_er_index''].pct_change()\n    df[''strategy_ret''] = df[''position''].shift(1) * df[''daily_ret'']\n    \n    # Performance metrics\n    total_days = len(df)\n    invested_days = df[''position''].sum()\n    total_ret = (1 + df[''strategy_ret'']).prod() - 1\n    years = (df[''Date''].max() - df[''Date''].min()).days / 365.25\n    ann_ret = (1 + total_ret) ** (1/years) - 1\n    \n    return {\n        ''total_return'': total_ret * 100,\n        ''annualized_return'': ann_ret * 100,\n        ''invested_pct'': invested_days / total_days * 100,\n        ''num_trades'': df[''position''].diff().abs().sum() / 2\n    }\n\n# Test different thresholds for CAD OAS z-score\nprint(''\\n=== Strategy 1: CAD OAS Z-Score Mean Reversion (20-day) ==='')\nfor threshold in [0.5, 1.0, 1.5, 2.0]:\n    result = backtest_strategy(df_clean, ''cad_oas_zscore20'', -999, threshold)\n    print(f''Threshold > {threshold}: Ann Ret = {result[\"\"annualized_return\"\"]:.2f}%, Invested = {result[\"\"invested_pct\"\"]:.1f}%, Trades = {int(result[\"\"num_trades\"\"])}'')\n\nprint(''\\n=== Strategy 2: CAD OAS Z-Score Mean Reversion (30-day) ==='')\nfor threshold in [0.5, 1.0, 1.5, 2.0]:\n    result = backtest_strategy(df_clean, ''cad_oas_zscore30'', -999, threshold)\n    print(f''Threshold > {threshold}: Ann Ret = {result[\"\"annualized_return\"\"]:.2f}%, Invested = {result[\"\"invested_pct\"\"]:.1f}%, Trades = {int(result[\"\"num_trades\"\"])}'')\n\nprint(''\\n=== Strategy 3: US HY OAS Z-Score Mean Reversion (30-day) ==='')\nfor threshold in [0.5, 1.0, 1.5, 2.0]:\n    result = backtest_strategy(df_clean, ''us_hy_oas_zscore30'', -999, threshold)\n    print(f''Threshold > {threshold}: Ann Ret = {result[\"\"annualized_return\"\"]:.2f}%, Invested = {result[\"\"invested_pct\"\"]:.1f}%, Trades = {int(result[\"\"num_trades\"\"])}'')\n\")"
    ],
    "deny": [],
    "ask": []
  }
}
